<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>PosDelay Dashboard</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(180deg,#1A1A30,#121225);color:#E0E0EC;min-height:100vh;padding:10px;font-size:13px;}
.card{background:linear-gradient(180deg,#242444,#1A1A35);border:1px solid #2E2E52;border-radius:12px;padding:12px;margin-bottom:8px;}
.row{display:flex;align-items:center;gap:6px;}
.dot{width:8px;height:8px;border-radius:50%;display:inline-block;flex-shrink:0;}
.dg{background:#2ECC71;}.do{background:#E67E22;}.dr{background:#E74C3C;}.dd{background:#707088;}
.gauge{display:flex;gap:1px;height:26px;margin-bottom:2px;}
.gc{flex:1;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:bold;color:#FFF;border-radius:2px;opacity:.7;cursor:pointer;}
.gc.act{opacity:1;box-shadow:inset 0 0 0 2px #FFF;}
.btn{padding:3px 10px;border-radius:5px;border:none;font-size:12px;font-weight:600;cursor:pointer;color:#FFF;touch-action:manipulation;}
.bs{padding:2px 6px;font-size:11px;}
.bg{background:#2ECC71;}.bred{background:#E74C3C;}.bor{background:#E67E22;}.bn{background:#2A2A45;color:#E0E0EC;}.bb{background:#2AC1BC;}.bcp{background:#FFD700;color:#1A1A30;}
.sr{display:flex;align-items:center;justify-content:space-between;padding:5px 0;border-bottom:1px solid #2A2A45;}
.sr:last-child{border-bottom:none;}
.sl{font-size:12px;color:#9090A8;}
.sv{display:flex;align-items:center;gap:4px;}
input[type=number]{width:48px;background:#1A1A30;border:1px solid #2E2E52;border-radius:4px;color:#FFF;padding:4px 4px;text-align:center;font-size:14px;font-weight:bold;-moz-appearance:textfield;}input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;}
input[type=time]{background:#2A2A45;border:1px solid #2E2E52;color:#FFF;padding:3px 6px;border-radius:4px;font-size:12px;}
.tog{width:38px;height:20px;border-radius:10px;background:#E74C3C;position:relative;cursor:pointer;transition:background .2s;flex-shrink:0;}
.tog.on{background:#2ECC71;}.tog::after{content:'';width:16px;height:16px;border-radius:50%;background:#FFF;position:absolute;top:2px;left:2px;transition:left .2s;}.tog.on::after{left:20px;}
.ch{cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
.cb{display:none;}.cb.open{display:block;}
.logbox{background:#1A1A30;border:1px solid #2A2A45;border-radius:6px;padding:6px;max-height:180px;overflow-y:auto;font-family:monospace;font-size:10px;color:#707088;white-space:pre-wrap;word-break:break-all;}
canvas{width:100%;height:100px;display:block;margin-top:6px;}
.tabs{display:flex;gap:3px;margin-bottom:6px;}
.tab{padding:3px 10px;border-radius:5px;font-size:11px;cursor:pointer;background:#2A2A45;color:#9090A8;}.tab.active{background:#2AC1BC;color:#FFF;}
.sec{font-size:12px;font-weight:600;padding:5px 0;border-bottom:1px solid #2A2A45;margin-top:6px;}
.nbtn{width:100%;padding:8px;border-radius:6px;border:none;font-size:13px;font-weight:600;cursor:pointer;color:#FFF;margin-top:6px;touch-action:manipulation;}
.alert{padding:8px 12px;border-radius:8px;font-size:12px;font-weight:600;text-align:center;margin-bottom:8px;display:none;}
.alert.warn{background:#E74C3C33;border:1px solid #E74C3C;color:#E74C3C;display:block;}
.alert.ok{background:#2ECC7133;border:1px solid #2ECC71;color:#2ECC71;display:block;}
.conn{font-size:10px;text-align:right;margin-bottom:4px;}
.sync-row{display:flex;gap:4px;font-size:10px;flex-wrap:wrap;}
.sync-item{display:flex;align-items:center;gap:2px;}
.tbtn{padding:2px 8px;border-radius:4px;border:1px solid #2E2E52;font-size:10px;font-weight:600;cursor:pointer;background:#2A2A45;color:#E0E0EC;touch-action:manipulation;}
.tbtn.on{border-color:#2ECC71;color:#2ECC71;}
.tbtn.off{border-color:#E74C3C;color:#E74C3C;}
</style>
</head>
<body>

<div id="pullInd" style="text-align:center;color:#707088;font-size:11px;height:0;overflow:hidden;transition:height .2s">&#8595; 새로고침</div>
<div class="conn"><span class="dot dd" id="cD"></span> <span id="cT" style="color:#707088">...</span></div>
<div class="alert" id="alertB"></div>
<div class="alert" id="anomalyB"></div>

<!-- ═══ 1. 모니터링 ═══ -->
<div class="card">
  <div class="row" style="justify-content:space-between;margin-bottom:6px">
    <div class="row" style="gap:8px">
      <span style="color:#9090A8;font-size:12px">처리중</span>
      <span id="mCount" style="font-size:30px;font-weight:bold;color:#FFF">--</span>
      <span style="color:#9090A8;font-size:12px">건</span>
    </div>
    <span id="mStatus" style="font-size:14px;font-weight:600;color:#2ECC71">정상</span>
  </div>
  <div class="row" style="justify-content:space-between;padding:4px 0;border-top:1px solid #2A2A45;border-bottom:1px solid #2A2A45">
    <div class="row" style="gap:4px">
      <span style="color:#2AC1BC;font-size:12px;font-weight:600">배민</span>
      <span class="dot dd" id="mBd"></span>
      <span id="mBv" style="font-size:12px;font-weight:600;color:#2AC1BC">-</span>
    </div>
    <div class="row" style="gap:4px">
      <span style="color:#FFD700;font-size:12px;font-weight:600">쿠팡</span>
      <span class="dot dd" id="mCd"></span>
      <span id="mCv" style="font-size:12px;font-weight:600;color:#FFD700">-</span>
    </div>
  </div>
  <div style="padding:4px 0;border-bottom:1px solid #2A2A45">
    <div class="sync-row">
      <div class="sync-item"><span class="dot dd" id="sKd"></span><span id="sKt" style="color:#707088">KDS --</span></div>
      <span style="color:#2A2A45">|</span>
      <div class="sync-item"><span class="dot dd" id="sMd"></span><span id="sMt" style="color:#707088">MATE --</span></div>
      <span style="color:#2A2A45">|</span>
      <div class="sync-item"><span class="dot dd" id="sPd"></span><span id="sPt" style="color:#707088">PC --</span></div>
    </div>
    <div class="row" style="gap:4px;margin-top:4px">
      <button class="tbtn on" id="tK" onclick="togSource('kds')">K가동</button>
      <button class="tbtn off" id="tM" onclick="togSource('mate')">M정지</button>
      <button class="tbtn on" id="tP" onclick="togSource('pc')">PC가동</button>
      <span style="flex:1"></span>
      <span id="mRefresh" style="font-size:10px;color:#707088">수집 --</span>
    </div>
  </div>
  <div id="delayPred" style="padding:4px 0;border-bottom:1px solid #2A2A45;display:none">
    <div class="row" style="justify-content:space-between">
      <span style="font-size:11px;color:#9090A8">조리속도</span>
      <span id="dpSpeed" style="font-size:11px;color:#FFF;font-weight:600">-</span>
    </div>
    <div class="row" style="justify-content:space-between">
      <span style="font-size:11px;color:#2AC1BC">배민 예상지연</span>
      <span id="dpBaemin" style="font-size:11px;font-weight:600">-</span>
    </div>
    <div class="row" style="justify-content:space-between">
      <span style="font-size:11px;color:#FFD700">쿠팡 예상지연</span>
      <span id="dpCoupang" style="font-size:11px;font-weight:600">-</span>
    </div>
  </div>
  <div class="row" style="justify-content:space-between;padding-top:4px">
    <span id="mLast" style="font-size:10px;color:#707088;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">마지막: --</span>
    <div class="row" style="gap:3px">
      <button class="btn bs bb" onclick="doCheck('baemin')">배민</button>
      <button class="btn bs bcp" onclick="doCheck('coupang')">쿠팡</button>
      <button class="btn bs bn" onclick="doCheck('refresh')">정정</button>
      <button class="btn bs bg" onclick="doForceRefresh()" style="font-size:10px">&#8635;</button>
    </div>
  </div>
</div>

<!-- ═══ 1.5 조리모드 (모니터링 바로 아래) ═══ -->
<div class="card" id="cookCard">
  <div class="ch" onclick="togSec('ckB')">
    <div class="row" style="gap:6px">
      <span style="font-size:13px;font-weight:600;color:#9090A8">조리모드</span>
      <div class="tog" id="tog_cook_mode" onclick="event.stopPropagation();togCookMode()"></div>
      <span id="ckStatus" style="font-size:11px;font-weight:600;color:#2ECC71"></span>
    </div>
    <span id="ckA" style="color:#9090A8">&#9660;</span>
  </div>
  <div class="cb open" id="ckB">
    <div class="sr"><span class="sl">전체</span><div class="sv"><button class="btn bs bn" onclick="adjCk('target',-1)">-</button><input type="number" id="ck_target" value="25" style="width:40px" onchange="saveCk()" readonly><button class="btn bs bn" onclick="adjCk('target',1)">+</button><span style="color:#707088;font-size:10px">분</span></div></div>
    <div class="sr"><span class="sl" style="color:#E67E22">조리</span><div class="sv"><button class="btn bs bn" onclick="adjCk('mid',-1)">-</button><input type="number" id="ck_mid" value="17" style="width:40px" onchange="saveCk()" readonly><button class="btn bs bn" onclick="adjCk('mid',1)">+</button><span style="color:#707088;font-size:10px">분</span></div></div>
    <div class="sr"><span class="sl" style="color:#E74C3C">포장</span><div class="sv"><button class="btn bs bn" onclick="adjCk('finish',-1)">-</button><input type="number" id="ck_finish" value="4" style="width:40px" onchange="saveCk()" readonly><button class="btn bs bn" onclick="adjCk('finish',1)">+</button><span style="color:#707088;font-size:10px">분</span></div></div>
    <div id="cookQ" style="margin-top:6px;font-size:12px;color:#707088">대기중</div>
  </div>
  <!-- 실시간 리스트 (설정 접힘과 무관하게 항상 표시) -->
  <div id="cookListArea" style="display:none;margin-top:6px;border-top:1px solid #2A2A45;padding-top:6px">
    <div id="cookList"></div>
  </div>
</div>

<!-- ═══ 2. 게이지 ═══ -->
<div class="card">
  <div style="margin-bottom:8px">
    <div class="row" style="justify-content:space-between;margin-bottom:6px">
      <div class="row" style="gap:6px">
        <span style="color:#FFD700;font-size:12px;font-weight:600">쿠팡</span>
        <span id="cSt" style="font-size:11px"></span>
      </div>
      <div class="row" style="gap:6px">
        <button class="btn bs bg" style="min-width:36px" onclick="exAd('coupang','on')">ON</button>
        <button class="btn bs bred" style="min-width:36px" onclick="exAd('coupang','off')">OFF</button>
      </div>
    </div>
    <div class="gauge" id="cG"></div>
  </div>
  <div style="border-top:1px solid #2A2A45;padding-top:8px">
    <div class="row" style="justify-content:space-between;margin-bottom:6px">
      <div class="row" style="gap:6px">
        <span style="color:#2AC1BC;font-size:12px;font-weight:600">배민</span>
        <span id="bSt" style="font-size:11px"></span>
      </div>
      <div class="row" style="gap:6px">
        <button class="btn bs bg" style="min-width:36px" onclick="exAd('baemin','max')">최대</button>
        <button class="btn bs bor" style="min-width:36px" onclick="exAd('baemin','mid')">중간</button>
        <button class="btn bs bred" style="min-width:36px" onclick="exAd('baemin','min')">최소</button>
      </div>
    </div>
    <div class="gauge" id="bG"></div>
  </div>
  <div id="gaugeLegend" style="display:none;gap:8px;justify-content:center;padding-top:4px;border-top:1px solid #2A2A45;margin-top:4px"></div>
</div>

<!-- ═══ 3. 광고 설정 ═══ -->
<div class="card">
  <div class="row" style="justify-content:space-between;margin-bottom:6px">
    <div class="ch" onclick="togSec('adB')" style="flex:1">
      <span style="font-size:13px;font-weight:600;color:#9090A8">광고 설정</span>
      <span id="adA" style="color:#9090A8">&#9660;</span>
    </div>
    <div class="row" style="gap:3px">
      <button class="btn bs bg" onclick="saveAll()" style="font-size:10px;padding:2px 8px">저장</button>
      <button class="btn bs bn" onclick="restoreAll()" style="font-size:10px;padding:2px 8px">복원</button>
    </div>
  </div>
  <div class="cb open" id="adB">
    <div class="sec" style="color:#2AC1BC">배민 금액</div>
    <div class="sr"><span class="sl" style="color:#2ECC71">최대</span><div class="sv"><button class="btn bs bn" onclick="adjS('baemin_amount',-50)">-</button><input type="number" id="set_baemin_amount" style="width:65px" readonly><button class="btn bs bn" onclick="adjS('baemin_amount',50)">+</button></div></div>
    <div class="sr"><span class="sl" style="color:#E67E22">중간</span><div class="sv"><button class="btn bs bn" onclick="adjS('baemin_mid_amount',-50)">-</button><input type="number" id="set_baemin_mid_amount" style="width:65px" readonly><button class="btn bs bn" onclick="adjS('baemin_mid_amount',50)">+</button></div></div>
    <div class="sr"><span class="sl" style="color:#E74C3C">최소</span><div class="sv"><button class="btn bs bn" onclick="adjS('baemin_reduced_amount',-50)">-</button><input type="number" id="set_baemin_reduced_amount" style="width:65px" readonly><button class="btn bs bn" onclick="adjS('baemin_reduced_amount',50)">+</button></div></div>
    <div class="sec">토글</div>
    <div class="sr"><span class="sl">광고 마스터</span><div class="tog" id="tog_ad_enabled" onclick="togS('ad_enabled')"></div></div>
    <div class="sr"><span class="sl">건수 자동</span><div class="tog" id="tog_order_auto_off_enabled" onclick="togS('order_auto_off_enabled')"></div></div>
    <div class="sr"><span class="sl">쿠팡 자동</span><div class="tog" id="tog_coupang_auto_enabled" onclick="togS('coupang_auto_enabled')"></div></div>
    <div class="sr"><span class="sl">배민 자동</span><div class="tog" id="tog_baemin_auto_enabled" onclick="togS('baemin_auto_enabled')"></div></div>
    <div class="sec">스케줄</div>
    <div class="sr">
      <div class="row" style="gap:4px">
        <div class="tog" id="tog_schedule_enabled2" onclick="togS('schedule_enabled')"></div>
        <span class="dot dr" id="schDot2"></span>
      </div>
      <div class="row" style="gap:4px">
        <span id="schOnDisp" style="font-size:14px;font-weight:bold;color:#FFF;cursor:pointer" onclick="pickTime('on')">--:--</span>
        <span style="color:#707088;font-size:12px">~</span>
        <span id="schOffDisp" style="font-size:14px;font-weight:bold;color:#FFF;cursor:pointer" onclick="pickTime('off')">--:--</span>
      </div>
    </div>
    <input type="time" id="schTimePicker" style="position:absolute;opacity:0;pointer-events:none">
  </div>
</div>

<!-- ═══ 4. 지연 설정 ═══ -->
<div class="card">
  <div class="ch" onclick="togSec('dlB')">
    <span style="font-size:13px;font-weight:600;color:#9090A8">지연 설정</span>
    <span id="dlA" style="color:#9090A8">&#9660;</span>
  </div>
  <div class="cb open" id="dlB">
    <div style="font-size:10px;color:#707088;padding:4px 0">지연 = max(0, 건수 × 완료간격 + 고정조리 - 목표)</div>
    <div class="sec" style="color:#2AC1BC">배민</div>
    <div class="sr"><span class="sl">목표시간</span><div class="sv"><button class="btn bs bn" onclick="adjS('baemin_target_time',-1)">-</button><input type="number" id="set_baemin_target_time" min="15" max="30" readonly><button class="btn bs bn" onclick="adjS('baemin_target_time',1)">+</button><span style="color:#707088;font-size:10px">분</span></div></div>
    <div class="sr"><span class="sl">고정조리</span><div class="sv"><button class="btn bs bn" onclick="adjS('baemin_fixed_cook_time',-1)">-</button><input type="number" id="set_baemin_fixed_cook_time" min="0" max="20" readonly><button class="btn bs bn" onclick="adjS('baemin_fixed_cook_time',1)">+</button><span style="color:#707088;font-size:10px">분</span></div></div>
    <div class="sr"><span class="sl">임계값</span><div class="sv"><button class="btn bs bn" onclick="adjS('baemin_delay_threshold',-1)">-</button><input type="number" id="set_baemin_delay_threshold" min="1" max="10" readonly><button class="btn bs bn" onclick="adjS('baemin_delay_threshold',1)">+</button><span style="color:#707088;font-size:10px">건</span></div></div>
    <div class="sec" style="color:#FFD700">쿠팡</div>
    <div class="sr"><span class="sl">목표시간</span><div class="sv"><button class="btn bs bn" onclick="adjS('coupang_target_time',-1)">-</button><input type="number" id="set_coupang_target_time" min="15" max="30" readonly><button class="btn bs bn" onclick="adjS('coupang_target_time',1)">+</button><span style="color:#707088;font-size:10px">분</span></div></div>
    <div class="sr"><span class="sl">고정조리</span><div class="sv"><button class="btn bs bn" onclick="adjS('coupang_fixed_cook_time',-1)">-</button><input type="number" id="set_coupang_fixed_cook_time" min="0" max="20" readonly><button class="btn bs bn" onclick="adjS('coupang_fixed_cook_time',1)">+</button><span style="color:#707088;font-size:10px">분</span></div></div>
    <div class="sr"><span class="sl">임계값</span><div class="sv"><button class="btn bs bn" onclick="adjS('coupang_delay_threshold',-1)">-</button><input type="number" id="set_coupang_delay_threshold" min="1" max="10" readonly><button class="btn bs bn" onclick="adjS('coupang_delay_threshold',1)">+</button><span style="color:#707088;font-size:10px">건</span></div></div>
  </div>
</div>

<!-- ═══ 5. 차트 ═══ -->
<div class="card">
  <div class="ch" onclick="togSec('chB')">
    <span style="font-size:13px;font-weight:600;color:#9090A8">건수 변동 (2시간)</span>
    <span id="chA" style="color:#9090A8">&#9660;</span>
  </div>
  <div class="cb open" id="chB"><canvas id="hChart"></canvas></div>
</div>

<!-- ═══ 6. 로그 ═══ -->
<div class="card">
  <div class="ch" onclick="togSec('lgB')">
    <span style="font-size:13px;font-weight:600;color:#9090A8">로그</span>
    <span id="lgA" style="color:#9090A8">&#9660;</span>
  </div>
  <div class="cb open" id="lgB">
    <div class="tabs">
      <div class="tab active" onclick="sLt('kds',this)">KDS</div>
      <div class="tab" onclick="sLt('posdelay',this)">PosDelay</div>
      <div class="tab" onclick="sLt('dump',this)">Dump</div>
    </div>
    <div class="logbox" id="logC">...</div>
  </div>
</div>

<!-- ═══ 7. 권한 ═══ -->
<div class="card" id="permCard" style="display:none">
  <div style="font-size:13px;font-weight:600;color:#9090A8;margin-bottom:6px">권한 / 앱 설정</div>
  <div class="sr"><div class="row"><span class="dot dd" id="pdD"></span><span class="sl" style="margin-left:4px">지연 접근성</span></div><button class="btn bs bb" onclick="nb('openAccessibilitySettings')">설정</button></div>
  <div class="sr"><div class="row"><span class="dot dd" id="pkD"></span><span class="sl" style="margin-left:4px">KDS 접근성</span></div><button class="btn bs bb" onclick="nb('openAccessibilitySettings')">설정</button></div>
  <div class="sr"><div class="row"><span class="dot dd" id="pnD"></span><span class="sl" style="margin-left:4px">알림 리스너</span></div><button class="btn bs bb" onclick="nb('openNotificationSettings')">설정</button></div>
  <div class="sr"><div class="row"><span class="dot dd" id="pbD"></span><span class="sl" style="margin-left:4px">배터리 최적화 면제</span></div><button class="btn bs bb" onclick="nb('openBatterySettings')">설정</button></div>
  <div class="sr"><span class="sl">앱 버전</span><span id="appVer" style="color:#FFF;font-size:12px">-</span></div>
  <div class="row" style="gap:4px;margin-top:6px">
    <button class="btn bb" onclick="nb('showLoginDialog','baemin')" style="flex:1">배민 로그인</button>
    <button class="btn bcp" onclick="nb('showLoginDialog','coupang')" style="flex:1">쿠팡 로그인</button>
  </div>
  <button class="nbtn bn" onclick="nb('openAppSettings')">앱 정보 (제한해제)</button>
</div>

<div style="text-align:center;color:#707088;font-size:10px;padding:12px 0;">PosDelay Dashboard v3.4</div>

<script>
const FB='https://poskds-4ba60-default-rtdb.asia-southeast1.firebasedatabase.app';
let S={},aS={},kS={},stS={},hD=[],oT={},cLt='kds';
let aTS=0;let sseLoaded=false;
let avgInterval=3.0;
const isApp=typeof NativeBridge!=='undefined';
// null-safe getter: 0도 유효한 값으로 처리
function g(obj,key,def){const v=obj[key];return v!=null?v:def;}

function nb(fn,...args){
  if(!isApp)return;
  try{
    if(fn==='executeAd')NativeBridge.executeAd(args[0],args[1]??0);
    else if(fn==='showLoginDialog')NativeBridge.showLoginDialog(args[0]);
    else if(fn==='refreshAndCorrect')NativeBridge.refreshAndCorrect();
    else if(fn==='forceRefresh')NativeBridge.forceRefresh();
    else if(fn==='openAccessibilitySettings')NativeBridge.openAccessibilitySettings();
    else if(fn==='openNotificationSettings')NativeBridge.openNotificationSettings();
    else if(fn==='openAppSettings')NativeBridge.openAppSettings();
    else if(fn==='trackUsage')NativeBridge.trackUsage(args[0]);
  }catch(e){}
}

if(isApp){
  document.getElementById('permCard').style.display='block';
  try{document.getElementById('appVer').textContent='v'+NativeBridge.getAppVersion();}catch(e){}
  setInterval(()=>{try{
    const p=JSON.parse(NativeBridge.getPermissions());
    document.getElementById('pdD').className='dot '+(p.delay?'dg':'dr');
    document.getElementById('pkD').className='dot '+(p.kds?'dg':'dr');
    document.getElementById('pnD').className='dot '+(p.notification?'dg':'dr');
    document.getElementById('pbD').className='dot '+(p.battery?'dg':'dr');
  }catch(e){}},3000);
}

// === SSE ===
function sse(path,cb){
  const es=new EventSource(FB+path);
  es.onopen=()=>updC(true);
  es.onerror=()=>{updC(false);setTimeout(()=>{es.close();sse(path,cb);},10000);};
  es.addEventListener('put',e=>cb(JSON.parse(e.data)));
  es.addEventListener('patch',e=>cb(JSON.parse(e.data)));
}
function updC(ok){
  document.getElementById('cD').className='dot '+(ok?'dg':'dr');
  const t=document.getElementById('cT');t.textContent=ok?'실시간':'폴링';t.style.color=ok?'#2ECC71':'#E67E22';
  if(ok)_sseOk=true;else _sseOk=false;
}

// === Data Handlers ===
function hKds(m){
  if(!m.data||m.data==='null')return;
  if(m.path==='/')Object.assign(kS,m.data);else kS[m.path.slice(1)]=m.data;
  // 교차검증: count>0인데 orders 비어있으면 0으로 보정
  if(kS.count>0&&(!kS.orders||kS.orders.length===0))kS.count=0;
  updMonitor();
}
function hSet(m){
  if(!m.data||m.data==='null')return;
  if(Date.now()<_localEditUntil)return; // 로컬 변경 중 SSE 무시
  if(m.path==='/')Object.assign(S,m.data);else S[m.path.slice(1)]=m.data;
  sseLoaded=true;try{localStorage.setItem('ad_settings_backup',JSON.stringify(S));}catch(e){}updSetUI();updMonitor();
}
function hASt(m){
  if(!m.data||m.data==='null')return;
  if(m.path==='/')Object.assign(aS,m.data);else aS[m.path.slice(1)]=m.data;
  updMonitor();
}
function hStatus(m){
  if(!m.data||m.data==='null')return;
  if(Date.now()<_localEditUntil)return; // 로컬 변경 중 SSE 무시
  if(m.path==='/')Object.assign(stS,m.data);else stS[m.path.slice(1)]=m.data;
  updSyncStatus();updMonitor();
}
function hHist(m){
  if(!m.data||m.data==='null')return;
  if(m.path==='/'&&m.data.entries)hD=m.data.entries;
  calcAvgInterval();drawChart();updDelayPred();
}

// === 건수: 소스 우선순위 ===
function getActiveCount(){
  // KDS 활성+데이터 있으면 KDS 직접값
  if(!stS.kds_paused&&kS.count!=null)return kS.count;
  // 아니면 앱 통합 건수 (MATE/PC 포함)
  if(stS.order_count!=null)return stS.order_count;
  // 최후: KDS 마지막값
  return kS.count;
}

// === 모니터링 ===
function updMonitor(){
  const c=getActiveCount();
  document.getElementById('mCount').textContent=c!=null?c:'--';
  const st=document.getElementById('mStatus');
  if(c!=null){
    const ci=Math.min(c,10);
    const cz=getZones('coupang'),bz=getZones('baemin');
    const cState=cz[ci],bState=bz[ci];
    if(cState===2||bState===3){st.textContent='끄기/최소';st.style.color='#E74C3C';}
    else if(bState===2){st.textContent='중간';st.style.color='#E67E22';}
    else if(cState===1||bState===1){st.textContent='정상';st.style.color='#2ECC71';}
    else{st.textContent='유지';st.style.color='#9090A8';}
  }
  const b=aS.baemin_current_bid;
  document.getElementById('mBv').textContent=b!=null&&b>0?b+'원':'-';
  document.getElementById('mBd').className='dot '+(b>0?(b>=g(S,'baemin_amount',200)?'dg':b>=g(S,'baemin_mid_amount',100)?'do':'dr'):'dd');
  const co2=aS.coupang_current_on;
  document.getElementById('mCv').textContent=co2===true?'ON':co2===false?'OFF':'-';
  document.getElementById('mCd').className='dot '+(co2===true?'dg':co2===false?'dr':'dd');
  document.getElementById('mLast').textContent='마지막: '+(aS.last_ad_action??'--');
  updCkQueue();updGauges(c);updDelayPred();chkAlert(c);
}

// === 동기화 상태 ===
function updSyncStatus(){
  updSyncItem('sKd','sKt','KDS',stS.kds_sync);
  updSyncItem('sMd','sMt','MATE',stS.mate_sync);
  updSyncItem('sPd','sPt','PC',stS.pc_sync);
  const tK=document.getElementById('tK'),tM=document.getElementById('tM'),tP=document.getElementById('tP');
  const kp=stS.kds_paused,mp=stS.mate_paused,pp=stS.pc_paused;
  tK.className='tbtn '+(kp?'off':'on');tK.textContent=kp?'K정지':'K가동';
  tM.className='tbtn '+(mp?'off':'on');tM.textContent=mp?'M정지':'M가동';
  tP.className='tbtn '+(pp?'off':'on');tP.textContent=pp?'PC정지':'PC가동';
}
function updSyncItem(dotId,txtId,label,ts){
  const d=document.getElementById(dotId),t=document.getElementById(txtId);
  if(!ts||ts===0){d.className='dot dd';t.textContent=label+' --';t.style.color='#707088';return;}
  const ago=Math.floor((Date.now()-ts)/1000);
  const agoStr=ago<60?ago+'초':ago<3600?Math.floor(ago/60)+'분':Math.floor(ago/3600)+'시간';
  const tm=new Date(ts);
  const tmStr=tm.getHours()+':'+String(tm.getMinutes()).padStart(2,'0')+':'+String(tm.getSeconds()).padStart(2,'0');
  t.textContent=label+' '+tmStr+' ('+agoStr+')';
  if(ago<180){d.className='dot dg';t.style.color='#2ECC71';}
  else if(ago<600){d.className='dot do';t.style.color='#E67E22';}
  else{d.className='dot dr';t.style.color='#E74C3C';}
}
function togSource(src){
  // 즉시 UI 반영 (낙관적 업데이트)
  const key=src+'_paused';
  stS[key]=!stS[key];
  updSyncStatus();
  _localEditUntil=Date.now()+3000;
  if(isApp){
    try{NativeBridge.toggleSource(src);}catch(e){}
    nb('trackUsage','toggle_'+src);
    setTimeout(()=>{try{
      const st=JSON.parse(NativeBridge.getSourceStatus());
      stS.kds_paused=st.kds_paused;stS.mate_paused=st.mate_paused;stS.pc_paused=st.pc_paused;
      updSyncStatus();
    }catch(e){}},300);
  }else{
    sendCmd('TOGGLE_'+src.toUpperCase());
  }
}

// === 게이지 (셀 배열 기반) ===
// 쿠팡: 0=hold, 1=on(초록), 2=off(빨강)
// 배민: 0=hold, 1=max(초록), 2=mid(주황), 3=min(빨강)
const CZ_DEF=[1,1,1,0,0,2,2,2,2,2,2]; // 쿠팡 기본
const BZ_DEF=[1,1,1,0,2,2,0,3,3,3,3]; // 배민 기본
const CZ_COLORS={'0':'#2A2A45','1':'#2ECC71','2':'#E74C3C'};
const BZ_COLORS={'0':'#2A2A45','1':'#2ECC71','2':'#E67E22','3':'#E74C3C'};
const CZ_NEXT={'0':1,'1':2,'2':0}; // 순환: hold→on→off→hold
const BZ_NEXT={'0':1,'1':2,'2':3,'3':0}; // hold→max→mid→min→hold

function getZones(platform){
  const key=platform==='coupang'?'coupang_zones':'baemin_zones';
  const def=platform==='coupang'?CZ_DEF:BZ_DEF;
  let z=S[key];
  if(!z||!Array.isArray(z)||z.length!==11){
    try{const b=JSON.parse(localStorage.getItem('ad_settings_backup'));if(b&&b[key]&&Array.isArray(b[key])&&b[key].length===11)return b[key].slice();}catch(e){}
    return def.slice();
  }
  return z.slice();
}
function setZones(platform,zones){
  const key=platform==='coupang'?'coupang_zones':'baemin_zones';
  S[key]=zones;
  updGauges(getActiveCount());
  _autoSave();
}
function tapGauge(platform,idx){
  nb('trackUsage','gauge_paint_'+platform+'_'+idx);
  const zones=getZones(platform);
  const next=platform==='coupang'?CZ_NEXT:BZ_NEXT;
  zones[idx]=next[zones[idx]]??0;
  setZones(platform,zones);
}

function updGauges(c){
  const cz=getZones('coupang'), bz=getZones('baemin');
  // 조리모드 구간 예상: 현재 건수 + 조리속도 기반
  let ckMidIdx=-1,ckFinIdx=-1; // 조리시작/포장시작 건수
  if(ckOn&&c!=null&&avgInterval>0){
    const tgt=parseInt(document.getElementById('ck_target').value)||20;
    const midMin=parseInt(document.getElementById('ck_mid').value)||12;
    const finMin=parseInt(document.getElementById('ck_finish').value)||3;
    // N건 밀리면 대기시간 = N × avgInterval분
    // 조리 구간: 대기시간 >= (목표-조리)분 → N >= (tgt-mid)/avg
    // 포장 구간: 대기시간 >= (목표-포장)분 → N >= (tgt-fin)/avg
    ckMidIdx=Math.ceil((tgt-midMin)/avgInterval);
    ckFinIdx=Math.ceil((tgt-finMin)/avgInterval);
  }
  function cellMark(i){
    if(!ckOn||ckMidIdx<0)return '';
    if(i>=ckFinIdx)return '<span style="position:absolute;bottom:0;left:0;right:0;height:2px;background:#E74C3C;opacity:.8"></span>';
    if(i>=ckMidIdx)return '<span style="position:absolute;bottom:0;left:0;right:0;height:2px;background:#E67E22;opacity:.8"></span>';
    return '';
  }
  let h='';
  for(let i=0;i<=10;i++){
    h+=`<div class="gc${c!=null&&i===c?' act':''}" style="background:${CZ_COLORS[cz[i]]};position:relative" onclick="tapGauge('coupang',${i})">${i}${cellMark(i)}</div>`;
  }
  document.getElementById('cG').innerHTML=h;
  if(c!=null){
    const cs=cz[c];
    document.getElementById('cSt').innerHTML=cs===2?'<span style="color:#E74C3C">OFF</span>':cs===1?'<span style="color:#2ECC71">ON</span>':'<span style="color:#9090A8">유지</span>';
  }
  h='';
  for(let i=0;i<=10;i++){
    h+=`<div class="gc${c!=null&&i===c?' act':''}" style="background:${BZ_COLORS[bz[i]]};position:relative" onclick="tapGauge('baemin',${i})">${i}${cellMark(i)}</div>`;
  }
  document.getElementById('bG').innerHTML=h;
  const ba=g(S,'baemin_amount',200),bma=g(S,'baemin_mid_amount',100),bra=g(S,'baemin_reduced_amount',50);
  if(c!=null){
    const bs2=bz[c];
    document.getElementById('bSt').innerHTML=bs2===3?`<span style="color:#E74C3C">최소 ${bra}원</span>`:bs2===2?`<span style="color:#E67E22">중간 ${bma}원</span>`:bs2===1?`<span style="color:#2ECC71">최대 ${ba}원</span>`:'<span style="color:#9090A8">유지</span>';
  }
  // 게이지 아래 조리구간 범례
  const lgEl=document.getElementById('gaugeLegend');
  if(lgEl){
    if(ckOn&&ckMidIdx>=0){
      lgEl.style.display='flex';
      lgEl.innerHTML=`<span style="color:#2ECC71;font-size:9px">대기 0~${ckMidIdx-1}</span><span style="color:#E67E22;font-size:9px">조리 ${ckMidIdx}~${ckFinIdx-1}</span><span style="color:#E74C3C;font-size:9px">포장 ${ckFinIdx}+</span><span style="color:#707088;font-size:9px">(${avgInterval.toFixed(1)}분/건)</span>`;
    }else{lgEl.style.display='none';}
  }
}

// === Firebase 명령 전송 (웹→Firebase→앱) ===
function sendCmd(action,amount){
  const cmd={action:action,amount:amount||0,time:Date.now(),source:'web'};
  fetch(FB+'/posdelay/command.json',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(cmd)})
    .then(()=>toast(action.replace(/_/g,' ')+' 전송'))
    .catch(()=>toast('전송 실패'));
}
function doCheck(what){
  if(isApp){
    if(what==='refresh')nb('refreshAndCorrect');
    else if(what==='baemin')nb('executeAd','BAEMIN_CHECK',0);
    else nb('executeAd','COUPANG_CHECK',0);
  }else{
    if(what==='refresh')sendCmd('REFRESH_CORRECT');
    else if(what==='baemin')sendCmd('BAEMIN_CHECK');
    else sendCmd('COUPANG_CHECK');
  }
}
function doForceRefresh(){
  if(isApp){nb('forceRefresh');}
  else{
    // 웹에서는 SSE 재연결 + 전체 데이터 새로 가져오기
    _sseOk=false;pollAll();toast('새로고침...');
  }
}

// === 실행 버튼 ===
function exAd(platform,action){
  const ba=g(S,'baemin_amount',200),bma=g(S,'baemin_mid_amount',100),bra=g(S,'baemin_reduced_amount',50);
  if(isApp){
    nb('trackUsage','exec_'+platform+'_'+action);
    if(platform==='coupang'){
      if(action==='on')nb('executeAd','COUPANG_AD_ON',0);
      else nb('executeAd','COUPANG_AD_OFF',0);
    }else{
      if(action==='max')nb('executeAd','BAEMIN_SET_AMOUNT',ba);
      else if(action==='mid')nb('executeAd','BAEMIN_SET_AMOUNT',bma);
      else nb('executeAd','BAEMIN_SET_AMOUNT',bra);
    }
  }else{
    if(platform==='coupang'){
      sendCmd(action==='on'?'COUPANG_AD_ON':'COUPANG_AD_OFF');
    }else{
      const amounts={max:ba,mid:bma,min:bra};
      sendCmd('BAEMIN_SET_AMOUNT',amounts[action]);
    }
  }
}

// === 조리 속도 ===
function calcAvgInterval(){
  if(!hD||hD.length<3)return;
  const ct=[];
  for(let i=1;i<hD.length;i++){
    if(hD[i].count<hD[i-1].count){
      const d=(hD[i].time-hD[i-1].time)/60000;
      ct.push(Math.max(2,Math.min(4,d)));
    }
  }
  if(ct.length>=2){const r=ct.slice(-10);avgInterval=r.reduce((a,b)=>a+b,0)/r.length;}
}

// === 지연 예측 ===
function updDelayPred(){
  const c=kS.count;
  const dp=document.getElementById('delayPred');
  if(c==null||c<1){dp.style.display='none';return;}
  dp.style.display='block';
  document.getElementById('dpSpeed').textContent=avgInterval.toFixed(1)+'분/건';
  const btt=g(S,'baemin_target_time',20),bfc=g(S,'baemin_fixed_cook_time',15);
  const bDelay=Math.max(0,Math.round(c*avgInterval+bfc-btt));
  const bEl=document.getElementById('dpBaemin');
  if(bDelay>0){bEl.textContent=bDelay+'분';bEl.style.color='#E74C3C';}
  else{bEl.textContent='0분';bEl.style.color='#2ECC71';}
  const ctt=g(S,'coupang_target_time',20),cfc=g(S,'coupang_fixed_cook_time',15);
  const cDelay=Math.max(0,Math.round(c*avgInterval+cfc-ctt));
  const cEl=document.getElementById('dpCoupang');
  if(cDelay>0){cEl.textContent=cDelay+'분';cEl.style.color='#E74C3C';}
  else{cEl.textContent='0분';cEl.style.color='#2ECC71';}
}

// === 설정 UI ===
function updSetUI(){
  const fields=['baemin_amount','baemin_mid_amount','baemin_reduced_amount','baemin_target_time','baemin_fixed_cook_time','baemin_delay_threshold','coupang_target_time','coupang_fixed_cook_time','coupang_delay_threshold'];
  fields.forEach(f=>{const e=document.getElementById('set_'+f);if(e&&S[f]!=null)e.value=S[f];});
  updSchDisp();
  ['ad_enabled','order_auto_off_enabled','coupang_auto_enabled','baemin_auto_enabled','schedule_enabled'].forEach(f=>{
    const e=document.getElementById('tog_'+f);if(e)e.className='tog'+(S[f]?' on':'');
  });
  const se2=document.getElementById('tog_schedule_enabled2');if(se2)se2.className='tog'+(S.schedule_enabled?' on':'');
  const sd2=document.getElementById('schDot2');if(sd2)sd2.className='dot '+(S.schedule_enabled?'dg':'dr');
  updGauges(getActiveCount());
}

// 설정 변경 → 즉시 Firebase 저장 + 게이지 갱신
let _saveTimer=null;
let _localEditUntil=0; // 로컬 변경 보호 타이머
function _autoSave(){
  if(!sseLoaded)return; // SSE 수신 전 저장 차단
  clearTimeout(_saveTimer);
  _localEditUntil=Date.now()+3000;
  _saveTimer=setTimeout(()=>{
    S._version=Date.now();S._updated_by='web';S._updated_at=new Date().toLocaleString('ko-KR');
    fetch(FB+'/posdelay/ad_settings.json',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(S)});
  },500);
}
function adjS(k,d){const e=document.getElementById('set_'+k);if(!e)return;e.value=parseInt(e.value??0)+d;S[k]=parseInt(e.value);updMonitor();_autoSave();}
function saveS(k,v){S[k]=isNaN(v)?v:parseInt(v);updMonitor();_autoSave();}
function togS(k){S[k]=!S[k];const e=document.getElementById('tog_'+k);if(e)e.className='tog'+(S[k]?' on':'');if(k==='schedule_enabled'){const d=document.getElementById('schDot2');if(d)d.className='dot '+(S[k]?'dg':'dr');const t=document.getElementById('tog_schedule_enabled2');if(t)t.className='tog'+(S[k]?' on':'');}_autoSave();}

// === 스케줄 시간 ===
let _pickTarget='';
function pickTime(which){
  _pickTarget=which;
  const pk=document.getElementById('schTimePicker');
  pk.style.pointerEvents='auto';pk.focus();pk.click();
  pk.onchange=function(){
    const v=pk.value;if(!v)return;
    if(_pickTarget==='on'){saveS('ad_on_time',v);document.getElementById('schOnDisp').textContent=v;}
    else{saveS('ad_off_time',v);document.getElementById('schOffDisp').textContent=v;}
    pk.style.pointerEvents='none';
  };
}
function updSchDisp(){
  const on=S.ad_on_time||'';const off=S.ad_off_time||'';
  document.getElementById('schOnDisp').textContent=on||'--:--';
  document.getElementById('schOffDisp').textContent=off||'--:--';
}

// === 저장/복원 ===
function saveAll(){
  if(!sseLoaded||Object.keys(S).length<3){toast('데이터 미수신 - 저장 불가');return;}
  S._ck={on:ckOn,t:parseInt(document.getElementById('ck_target').value)||20,m:parseInt(document.getElementById('ck_mid').value)||12,f:parseInt(document.getElementById('ck_finish').value)||3};
  try{localStorage.setItem('ad_settings_backup',JSON.stringify(S));}catch(e){}
  saveCk();
  S._version=Date.now();S._updated_by='web';S._updated_at=new Date().toLocaleString('ko-KR');
  fetch(FB+'/posdelay/ad_settings.json',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(S)}).then(()=>toast('저장 완료')).catch(()=>toast('저장 실패'));
}
function restoreAll(){
  try{
    const b=localStorage.getItem('ad_settings_backup');
    if(!b){toast('백업 없음');return;}
    const d=JSON.parse(b);Object.assign(S,d);sseLoaded=true;
    if(d._ck){ckOn=!!d._ck.on;document.getElementById('tog_cook_mode').className='tog'+(ckOn?' on':'');document.getElementById('ck_target').value=d._ck.t||20;document.getElementById('ck_mid').value=d._ck.m||12;document.getElementById('ck_finish').value=d._ck.f||3;saveCk();}
    updSetUI();updMonitor();
    fetch(FB+'/posdelay/ad_settings.json',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(S)}).then(()=>toast('복원 완료')).catch(()=>toast('복원 실패'));
  }catch(e){toast('복원 실패');}
}

// === 알림 ===
let alertMode='normal';
let lastAlertTime=0;
const ALERT_REPEAT=180000;

function chkAlert(c){
  if(c==null)return;
  const bdt=g(S,'baemin_delay_threshold',5),cdt=g(S,'coupang_delay_threshold',5);
  const btt=g(S,'baemin_target_time',20),bfc=g(S,'baemin_fixed_cook_time',15);
  const ctt=g(S,'coupang_target_time',20),cfc=g(S,'coupang_fixed_cook_time',15);
  const bn=document.getElementById('alertB');
  const now=Date.now();
  let msgs=[];
  const bDelay=Math.max(0,Math.round(c*avgInterval+bfc-btt));
  const cDelay=Math.max(0,Math.round(c*avgInterval+cfc-ctt));
  const bBrk=avgInterval>0?Math.floor((btt-bfc)/avgInterval):0;
  const cBrk=avgInterval>0?Math.floor((ctt-cfc)/avgInterval):0;
  if(c>=bdt&&bDelay>0)msgs.push('배민 '+bDelay+'분 '+Math.max(0,c-bBrk)+'건');
  if(c>=cdt&&cDelay>0)msgs.push('쿠팡 '+cDelay+'분 '+Math.max(0,c-cBrk)+'건');
  if(msgs.length>0){
    const timeStr=fmtHM(aTS>0?new Date(aTS):new Date(now));
    bn.className='alert warn';
    bn.innerHTML=`&#9888; ${timeStr} 이후 지연 ${msgs.join(', ')}`;
    if(alertMode!=='delayed'){
      alertMode='delayed';aTS=now;lastAlertTime=now;
      sendNotif('주문 지연',`${fmtHM(new Date(now))} 이후 지연 ${msgs.join(', ')}`);
    }else if(now-lastAlertTime>=ALERT_REPEAT){
      lastAlertTime=now;
      const el=Math.floor((now-aTS)/60000);
      sendNotif('주문 지연 지속',`${timeStr} 이후 지연 ${msgs.join(', ')} (${el}분 경과)`);
    }
  }else{
    if(alertMode==='delayed'){
      alertMode='normal';
      const el=Math.floor((now-aTS)/60000);
      bn.className='alert ok';bn.textContent=`정상 복귀 (${el}분만에)`;
      sendNotif('정상 복귀',`정상 복귀 (${el}분만에)`);
      setTimeout(()=>{bn.className='alert';},10000);
    }
    aTS=0;
  }
}
function sendNotif(title,body){
  if('Notification'in window&&Notification.permission==='granted'){
    new Notification(title,{body:body,tag:'pd-alert'});
  }
}

// === 차트 ===
function drawChart(){
  const cv=document.getElementById('hChart');if(!cv||!hD||hD.length<2)return;
  const ctx=cv.getContext('2d');
  const now=Date.now(),t2h=now-7200000,data=hD.filter(e=>e.time>=t2h);if(data.length<2)return;
  const W=cv.width=cv.offsetWidth*2,H=cv.height=200;ctx.clearRect(0,0,W,H);
  const p={t:16,r:8,b:24,l:30},cw=W-p.l-p.r,ch=H-p.t-p.b;
  const mT=data[0].time,xT=data[data.length-1].time,mC=Math.max(...data.map(d=>d.count),5);
  const x=t=>p.l+((t-mT)/(xT-mT||1))*cw,y=c2=>p.t+ch-(c2/mC)*ch;
  ctx.strokeStyle='#2A2A45';ctx.lineWidth=1;
  for(let i=0;i<=4;i++){const gy=p.t+(ch/4)*i;ctx.beginPath();ctx.moveTo(p.l,gy);ctx.lineTo(W-p.r,gy);ctx.stroke();ctx.fillStyle='#707088';ctx.font='16px sans-serif';ctx.textAlign='right';ctx.fillText(Math.round(mC-(mC/4)*i),p.l-4,gy+4);}
  ctx.textAlign='center';const ts=(xT-mT)/3;
  for(let i=0;i<=3;i++){const t=mT+ts*i,d=new Date(t);ctx.fillText(d.getHours()+':'+String(d.getMinutes()).padStart(2,'0'),x(t),H-4);}
  const co3=g(S,'coupang_off_threshold',5);ctx.strokeStyle='#E74C3C44';ctx.lineWidth=2;ctx.setLineDash([6,3]);ctx.beginPath();ctx.moveTo(p.l,y(co3));ctx.lineTo(W-p.r,y(co3));ctx.stroke();ctx.setLineDash([]);
  ctx.strokeStyle='#2AC1BC';ctx.lineWidth=2;ctx.beginPath();
  data.forEach((d,i)=>{const px=x(d.time),py=y(d.count);i===0?ctx.moveTo(px,py):ctx.lineTo(px,py);});ctx.stroke();
  data.forEach(d=>{ctx.fillStyle=d.count>=co3?'#E74C3C':'#2ECC71';ctx.beginPath();ctx.arc(x(d.time),y(d.count),3,0,Math.PI*2);ctx.fill();});
}

// === 로그 ===
function sLt(tab,el){
  cLt=tab;document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));if(el)el.classList.add('active');
  const lc=document.getElementById('logC');lc.textContent='로딩...';
  const urls={kds:FB+'/kds_log.json',posdelay:FB+'/posdelay/logs.json',dump:FB+'/kds_dump.json'};
  fetch(urls[tab]).then(r=>r.json()).then(d=>{
    if(tab==='kds')lc.textContent=typeof d==='string'?d:JSON.stringify(d,null,2);
    else if(tab==='dump')lc.textContent=d&&d.tree?`[${d.time}] ${d.lines}줄\n${d.tree}`:'덤프 없음';
    else if(tab==='posdelay')lc.textContent=Array.isArray(d)?d.map(e=>`[${e.time}] ${e.msg}`).join('\n'):(d?JSON.stringify(d,null,2):'로그 없음');
    lc.scrollTop=lc.scrollHeight;
  }).catch(()=>{lc.textContent='로드 실패';});
}

// === 유틸 ===
function togSec(id){const e=document.getElementById(id),o=e.classList.toggle('open');const a=document.getElementById(id.replace('B','A'));if(a)a.innerHTML=o?'&#9660;':'&#9654;';if(id==='chB'&&o)setTimeout(drawChart,100);try{const c=JSON.parse(localStorage.getItem('_collapsed')||'{}');if(o)delete c[id];else c[id]=1;localStorage.setItem('_collapsed',JSON.stringify(c));}catch(e){}}
// 수동 접기 복원
try{const c=JSON.parse(localStorage.getItem('_collapsed')||'{}');Object.keys(c).forEach(id=>{const e=document.getElementById(id);if(e){e.classList.remove('open');const a=document.getElementById(id.replace('B','A'));if(a)a.innerHTML='&#9654;';}});}catch(e){}
function fmtHM(dt){return dt.getHours()+'시'+String(dt.getMinutes()).padStart(2,'0')+'분';}
function toast(m){const d=document.createElement('div');d.style.cssText='position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#2ECC71;color:#FFF;padding:8px 16px;border-radius:8px;font-size:13px;z-index:9999;';d.textContent=m;document.body.appendChild(d);setTimeout(()=>d.remove(),3000);}

// === 풀투리프레시 ===
let _pY=0,_pulling=false;
const _pInd=document.getElementById('pullInd');
document.addEventListener('touchstart',e=>{if(window.scrollY===0)_pY=e.touches[0].clientY;else _pY=0;},{passive:true});
document.addEventListener('touchmove',e=>{
  if(_pY===0)return;
  const d=e.touches[0].clientY-_pY;
  if(d>0&&d<150&&window.scrollY===0){_pulling=true;_pInd.style.height=Math.min(d/2,30)+'px';_pInd.textContent=d>80?'↑ 놓으면 새로고침':'↓ 새로고침';}
  else{_pulling=false;_pInd.style.height='0';}
},{passive:true});
document.addEventListener('touchend',()=>{
  if(_pulling&&parseInt(_pInd.style.height)>=25){_pInd.textContent='새로고침 중...';_pInd.style.height='24px';setTimeout(()=>location.reload(),300);}
  else{_pInd.style.height='0';}_pulling=false;_pY=0;
});

// === 조리모드 (주문번호 기반) ===
let ckOn=false,ckQ=[]; // ckQ: {num, t, onKds, ma, fa, da}

function togCookMode(){ckOn=!ckOn;document.getElementById('tog_cook_mode').className='tog'+(ckOn?' on':'');if(!ckOn){ckQ=[];updCkUI();}saveCk();}

function updCkQueue(){
  if(!ckOn)return;
  const orders=kS.orders||[];
  // 새 주문번호 등장 → 타이머 시작 (Firebase order_tracking 시간 우선)
  orders.forEach(n=>{
    if(!ckQ.find(o=>o.num===n)){
      const fbTime=oT[String(n)];  // Firebase에 저장된 최초 등장 시간
      ckQ.push({num:n,t:fbTime||Date.now(),onKds:true,ma:false,fa:false,da:false});
    }
  });
  // KDS에서 사라진 주문 표시 (제거하지 않음, onKds만 false)
  ckQ.forEach(o=>{o.onKds=orders.includes(o.num);});
}

function chkCkAlerts(){
  if(!ckOn)return;
  const tgt=parseInt(document.getElementById('ck_target').value)||20;
  const mid=parseInt(document.getElementById('ck_mid').value)||12;
  const fin=parseInt(document.getElementById('ck_finish').value)||3;
  const now=Date.now();
  // 시간초과 후 5분 지나면 자동 제거
  ckQ=ckQ.filter(o=>(now-o.t)/60000<tgt+5);
  ckQ.forEach(o=>{
    const rem=tgt-(now-o.t)/60000;
    if(isApp){
      // 조리: KDS에 아직 있는 건만
      if(rem<=mid&&!o.ma){o.ma=true;if(o.onKds){try{NativeBridge.speakCook(o.num+'번 조리');}catch(e){}}}
      // 포장: 모든 건
      if(rem<=fin&&!o.fa){o.fa=true;try{NativeBridge.speakCook(o.num+'번 포장');}catch(e){}}
      // 시간초과: 모든 건
      if(rem<=0&&!o.da){o.da=true;try{NativeBridge.speakCook(o.num+'번 시간초과');}catch(e){}}
    }
  });
  updCkUI();
}

function updCkUI(){
  const listArea=document.getElementById('cookListArea');
  const listEl=document.getElementById('cookList');
  const settingsEl=document.getElementById('cookQ');
  const ckStEl=document.getElementById('ckStatus');
  const activeOrders=ckQ.filter(o=>o.onKds).length;
  if(ckStEl){
    if(!ckOn){ckStEl.textContent='';ckStEl.style.color='#707088';}
    else if(activeOrders===0){ckStEl.textContent='대기';ckStEl.style.color='#9090A8';}
    else{ckStEl.textContent=activeOrders+'건';ckStEl.style.color=activeOrders>3?'#E74C3C':activeOrders>1?'#E67E22':'#2ECC71';}
  }
  if(!ckOn||ckQ.length===0){
    if(listArea)listArea.style.display=ckOn?'block':'none';
    if(settingsEl)settingsEl.innerHTML='<span style="color:#707088">대기중</span>';
    if(listEl&&ckOn)listEl.innerHTML='<div style="text-align:center;color:#707088;font-size:11px;padding:8px">주문 대기중</div>';
    return;
  }
  if(listArea)listArea.style.display='block';
  const tgt=parseInt(document.getElementById('ck_target').value)||25;
  const mid=parseInt(document.getElementById('ck_mid').value)||17;
  const fin=parseInt(document.getElementById('ck_finish').value)||4;
  const tgtMs=tgt*60000;const midMs=mid*60000;const finMs=fin*60000;
  const now=Date.now();
  const sorted=[...ckQ].sort((a,b)=>(tgtMs-(now-a.t))-(tgtMs-(now-b.t)));
  function mmss(ms){const m=Math.floor(ms/60000),s=Math.floor((ms%60000)/1000);return m+':'+String(s).padStart(2,'0');}
  let h='';
  sorted.forEach(o=>{
    const elMs=now-o.t;
    const remMs=Math.max(0,tgtMs-elMs);
    const overMs=Math.max(0,elMs-tgtMs);
    const pct=Math.min(100,(elMs/tgtMs)*100);
    const remMin=remMs/60000;
    // 상태 판정
    let st,bgCl;
    if(remMs<=0){st='초과';bgCl='#E74C3C';}
    else if(remMin<=fin){st='포장';bgCl='#E74C3C';}
    else if(remMin<=mid){st='조리';bgCl='#E67E22';}
    else{st='대기';bgCl='#2ECC71';}
    // 3개 타이머
    const allDisp=remMs>0?mmss(remMs):'+'+mmss(overMs);
    const allCl=remMs<=0?'#FFF':bgCl;
    const cookRemMs=Math.max(0,remMs-finMs);
    const cookDisp=remMin>mid?'--:--':remMin<=fin?'0:00':mmss(cookRemMs);
    const cookCl=remMin>mid?'#707088':'#E67E22';
    const pkgDisp=remMin>fin?'--:--':mmss(remMs);
    const pkgCl=remMin>fin?'#707088':'#E74C3C';
    const kds=o.onKds?'':'<span style="color:#707088;font-size:9px"> 완료</span>';
    const op=o.onKds?'1':'0.4';
    const oDate=new Date(o.t);
    const oTime=oDate.getHours()+':'+String(oDate.getMinutes()).padStart(2,'0');
    h+=`<div style="padding:4px 0;border-bottom:1px solid #2A2A45;opacity:${op}">
      <div style="display:flex;align-items:center;gap:6px">
        <span style="font-size:13px;font-weight:bold;color:#E0E0EC">${o.num}번${kds}</span>
        <span style="font-size:11px;color:#9090A8">${oTime}</span>
        <span style="flex:1"></span>
        <span style="font-size:11px;font-weight:700;color:${bgCl}">${st}</span>
      </div>
      <div style="display:flex;gap:8px;margin-top:2px;font-family:monospace;font-weight:bold">
        <span style="font-size:13px;color:${allCl}">전체 ${allDisp}</span>
        <span style="font-size:13px;color:${cookCl}">조리 ${cookDisp}</span>
        <span style="font-size:13px;color:${pkgCl}">포장 ${pkgDisp}</span>
      </div>
      <div style="background:#1A1A30;border-radius:2px;height:3px;margin-top:2px;overflow:hidden">
        <div style="width:${pct}%;height:100%;background:${bgCl};border-radius:2px"></div>
      </div>
    </div>`;
  });
  if(listEl)listEl.innerHTML=h;
  if(settingsEl)settingsEl.innerHTML=`<span style="color:#707088">${activeOrders}건 조리중</span>`;
}

function adjCk(k,d){const e=document.getElementById('ck_'+k);if(!e)return;e.value=Math.max(1,parseInt(e.value||0)+d);saveCk();}
function saveCk(){try{localStorage.setItem('ck',JSON.stringify({on:ckOn,t:parseInt(document.getElementById('ck_target').value)||20,m:parseInt(document.getElementById('ck_mid').value)||12,f:parseInt(document.getElementById('ck_finish').value)||3}));}catch(e){}}
function loadCk(){try{const s=JSON.parse(localStorage.getItem('ck'));if(s){ckOn=!!s.on;document.getElementById('tog_cook_mode').className='tog'+(ckOn?' on':'');if(s.t)document.getElementById('ck_target').value=s.t;if(s.m)document.getElementById('ck_mid').value=s.m;if(s.f)document.getElementById('ck_finish').value=s.f;}}catch(e){}}
loadCk();
setInterval(chkCkAlerts,1000);

// === 초기화 ===
if('Notification'in window&&Notification.permission==='default')Notification.requestPermission();
// 즉시 localStorage 복원 시도
try{const b=localStorage.getItem('ad_settings_backup');if(b){Object.assign(S,JSON.parse(b));updSetUI();updMonitor();}}catch(e){}
// HTTP 직접 조회 (SSE 백업)
fetch(FB+'/posdelay/ad_settings.json').then(r=>r.json()).then(d=>{
  if(d&&typeof d==='object'){Object.assign(S,d);sseLoaded=true;try{localStorage.setItem('ad_settings_backup',JSON.stringify(S));}catch(e){}updSetUI();updMonitor();}
}).catch(()=>{});
sse('/posdelay/order_tracking.json',m=>{
  if(!m.data||m.data==='null')return;
  if(m.path==='/')Object.assign(oT,m.data);else oT[m.path.slice(1)]=m.data;
});
sse('/kds_status.json',hKds);
sse('/posdelay/ad_settings.json',hSet);
sse('/posdelay/ad_state.json',hASt);
sse('/posdelay/status.json',hStatus);
sse('/kds_history.json',hHist);
// 이상신호 SSE
sse('/posdelay/alert.json',m=>{
  const ab=document.getElementById('anomalyB');
  if(!m.data||m.data==='null'){ab.className='alert';return;}
  const d=m.path==='/'?m.data:null;
  if(!d)return;
  const ts=d.timestamp||0;
  if(Date.now()-ts>10*60*1000){ab.className='alert';return;} // 10분 지난 알림 무시
  ab.className='alert warn';
  ab.innerHTML='&#9888; ['+d.type+'] '+d.message+' ('+d.time+')';
  if('Notification'in window&&Notification.permission==='granted'){
    new Notification('이상신호',{body:d.message,tag:'anomaly'});
  }
});
fetch(FB+'/kds_log.json').then(r=>r.json()).then(d=>{document.getElementById('logC').textContent=typeof d==='string'?d:JSON.stringify(d,null,2);}).catch(()=>{});
// 10초 폴링 (SSE 백업)
let _sseOk=false;
function pollAll(){
  if(_sseOk)return; // SSE 정상이면 폴링 안 함
  Promise.all([
    fetch(FB+'/kds_status.json').then(r=>r.json()),
    fetch(FB+'/posdelay/ad_state.json').then(r=>r.json()),
    fetch(FB+'/posdelay/status.json').then(r=>r.json()),
    fetch(FB+'/posdelay/ad_settings.json').then(r=>r.json()),
  ]).then(([k,a,st,s])=>{
    if(k)Object.assign(kS,k);
    if(a){Object.assign(aS,a);}
    if(st)Object.assign(stS,st);
    if(s&&typeof s==='object'){Object.assign(S,s);sseLoaded=true;try{localStorage.setItem('ad_settings_backup',JSON.stringify(S));}catch(e){}}
    updSetUI();updSyncStatus();updMonitor();
  }).catch(()=>{});
}
setInterval(pollAll,10000);
setTimeout(pollAll,2000); // 2초 후 첫 폴링
setInterval(()=>{
  const ls=stS.mate_sync??stS.pc_sync??0;
  if(ls>0){const ago=Math.floor((Date.now()-ls)/1000);const rem=Math.max(0,90-ago%90);document.getElementById('mRefresh').textContent='수집 '+rem+'초';}
},1000);
window.addEventListener('resize',drawChart);
</script>
</body>
</html>
